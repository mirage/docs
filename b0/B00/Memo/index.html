<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Memo (b0.B00.Memo)</title><link rel="stylesheet" href="../../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc v1.1.1-1373-g2e7c1c75"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><nav><a href="../index.html">Up</a> – <a href="../../index.html">b0</a> &#x00BB; <a href="../index.html">B00</a> &#x00BB; Memo</nav><header><h1>Module <code>B00.Memo</code></h1><p>Build memoizer.</p><p>A memoizer ties together and environment, an operation cache, a guard and an executor.</p></header><nav class="toc"><ul><li><a href="#memo">Memoizer</a></li><li><a href="#marks">Activity marks</a></li><li><a href="#fibers">Futures and fibers</a></li><li><a href="#feedback">Feedback</a></li><li><a href="#files">Files and directories</a></li><li><a href="#spawn">Memoizing tool spawns</a></li></ul></nav><div class="content"><h2 id="memo"><a href="#memo" class="anchor"></a>Memoizer</h2><div><div class="spec type" id="type-feedback" class="anchored"><a href="#type-feedback" class="anchor"></a><code><span class="keyword">type</span> feedback = [ </code><table><tr id="type-feedback.Miss_tool" class="anchored"><td class="def constructor"><a href="#type-feedback.Miss_tool" class="anchor"></a><code>| </code><code>`Miss_tool <span class="keyword">of</span> <a href="../Tool/index.html#type-t">Tool.t</a> * string</code></td></tr><tr id="type-feedback.Op_complete" class="anchored"><td class="def constructor"><a href="#type-feedback.Op_complete" class="anchor"></a><code>| </code><code>`Op_complete <span class="keyword">of</span> <a href="../../B000/Op/index.html#type-t">B000.Op.t</a></code></td></tr></table><code> ]</code></div><div><p>The type for memoizer feedback. FIXME remove `Miss_tool now that we have notify operations.</p></div></div><div><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code></div><div><p>The type for memoizers. This ties together an environment, a guard, an operation cache and an executor.</p></div></div><div class="spec value" id="val-create" class="anchored"><a href="#val-create" class="anchor"></a><code><span class="keyword">val</span> create : <span>?&#8288;clock:<a href="../../B00_std/Time/index.html#type-counter">B00_std.Time.counter</a></span> <span>&#45;&gt;</span> <span>?&#8288;cpu_clock:<a href="../../B00_std/Time/index.html#type-cpu_counter">B00_std.Time.cpu_counter</a></span> <span>&#45;&gt;</span> <span>feedback:<span>(<a href="index.html#type-feedback">feedback</a> <span>&#45;&gt;</span> unit)</span></span> <span>&#45;&gt;</span> <span>cwd:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a></span> <span>&#45;&gt;</span> <a href="../Env/index.html#type-t">Env.t</a> <span>&#45;&gt;</span> <a href="../../B000/Guard/index.html#type-t">B000.Guard.t</a> <span>&#45;&gt;</span> <a href="../../B000/Reviver/index.html#type-t">B000.Reviver.t</a> <span>&#45;&gt;</span> <a href="../../B000/Exec/index.html#type-t">B000.Exec.t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></div><div><div class="spec value" id="val-memo" class="anchored"><a href="#val-memo" class="anchor"></a><code><span class="keyword">val</span> memo : <span>?&#8288;hash_fun:<span>(<span class="keyword">module</span> <a href="../../B00_std/Hash/module-type-T/index.html">B00_std.Hash.T</a>)</span></span> <span>&#45;&gt;</span> <span>?&#8288;env:<a href="../../B00_std/Os/Env/index.html#type-t">B00_std.Os.Env.t</a></span> <span>&#45;&gt;</span> <span>?&#8288;cwd:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a></span> <span>&#45;&gt;</span> <span>?&#8288;cache_dir:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a></span> <span>&#45;&gt;</span> <span>?&#8288;trash_dir:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a></span> <span>&#45;&gt;</span> <span>?&#8288;jobs:int</span> <span>&#45;&gt;</span> <span>?&#8288;feedback:<span>(<span>[ <a href="index.html#type-feedback">feedback</a> <span>| <a href="../../B000/Exec/index.html#type-feedback">B000.Exec.feedback</a></span> ]</span> <span>&#45;&gt;</span> unit)</span></span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> <span><span>(<a href="index.html#type-t">t</a>, string)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></span></code></div><div><p><code>memo</code> is a simpler <a href="index.html#val-create"><code>create</code></a></p><ul><li><code>hash_fun</code> defaults to <a href="../../B00_std/Hash/Xxh_64/index.html"><code>B00_std.Hash.Xxh_64</code></a>.</li><li><code>jobs</code> defaults to <a href="../../B00_std/Os/Cpu/index.html#val-logical_count"><code>B00_std.Os.Cpu.logical_count</code></a>.</li><li><code>env</code> defaults to <a href="../../B00_std/Os/Env/index.html#val-current"><code>B00_std.Os.Env.current</code></a></li><li><code>cwd</code> defaults to <a href="../../B00_std/Os/index.html#cwd"><code>B00_std.Os.Dir:cwd</code></a></li><li><code>cache_dir</code> defaults to <code>Fpath.(cwd / &quot;_b0&quot; / &quot;.cache&quot;)</code></li><li><code>trash_dir</code> defaults to <code>Fpath.(cwd / &quot;_b0&quot; / &quot;.trash&quot;)</code></li><li><code>feedback</code> defaults to a nop.</li></ul></div></div><div><div class="spec value" id="val-clock" class="anchored"><a href="#val-clock" class="anchor"></a><code><span class="keyword">val</span> clock : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../B00_std/Time/index.html#type-counter">B00_std.Time.counter</a></code></div><div><p><code>clock m</code> is <code>m</code>'s clock.</p></div></div><div><div class="spec value" id="val-cpu_clock" class="anchored"><a href="#val-cpu_clock" class="anchor"></a><code><span class="keyword">val</span> cpu_clock : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../B00_std/Time/index.html#type-cpu_counter">B00_std.Time.cpu_counter</a></code></div><div><p><code>cpu_clock m</code> is <code>m</code>'s cpu clock.</p></div></div><div><div class="spec value" id="val-env" class="anchored"><a href="#val-env" class="anchor"></a><code><span class="keyword">val</span> env : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../Env/index.html#type-t">Env.t</a></code></div><div><p><code>env m</code> is <code>m</code>'s environment.</p></div></div><div><div class="spec value" id="val-reviver" class="anchored"><a href="#val-reviver" class="anchor"></a><code><span class="keyword">val</span> reviver : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../B000/Reviver/index.html#type-t">B000.Reviver.t</a></code></div><div><p><code>reviver m</code> is <code>m</code>'s reviver.</p></div></div><div><div class="spec value" id="val-guard" class="anchored"><a href="#val-guard" class="anchor"></a><code><span class="keyword">val</span> guard : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../B000/Guard/index.html#type-t">B000.Guard.t</a></code></div><div><p><code>guard m</code> is <code>m</code>'s guard.</p></div></div><div><div class="spec value" id="val-exec" class="anchored"><a href="#val-exec" class="anchor"></a><code><span class="keyword">val</span> exec : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../B000/Exec/index.html#type-t">B000.Exec.t</a></code></div><div><p><code>exec m</code> is <code>m</code>'s executors.</p></div></div><div><div class="spec value" id="val-trash" class="anchored"><a href="#val-trash" class="anchor"></a><code><span class="keyword">val</span> trash : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../B000/Trash/index.html#type-t">B000.Trash.t</a></code></div><div><p><code>trash m</code> is <code>m</code>'s trash.</p></div></div><div><div class="spec value" id="val-has_failures" class="anchored"><a href="#val-has_failures" class="anchor"></a><code><span class="keyword">val</span> has_failures : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> bool</code></div><div><p><code>has_failures m</code> is <code>true</code> iff at least one operation (or fiber) has failed.</p></div></div><div><div class="spec value" id="val-hash_string" class="anchored"><a href="#val-hash_string" class="anchor"></a><code><span class="keyword">val</span> hash_string : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <a href="../../B00_std/Hash/index.html#type-t">B00_std.Hash.t</a></code></div><div><p><code>hash_string m s</code> is <a href="../../B000/Reviver/index.html#val-hash_string"><code>B000.Reviver.hash_string</code></a><code> (reviver m) s</code>.</p></div></div><div><div class="spec value" id="val-hash_file" class="anchored"><a href="#val-hash_file" class="anchor"></a><code><span class="keyword">val</span> hash_file : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span>&#45;&gt;</span> <span><span>(<a href="../../B00_std/Hash/index.html#type-t">B00_std.Hash.t</a>, string)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></span></code></div><div><p><code>hash_file m f</code> is <a href="../../B000/Reviver/index.html#val-hash_file"><code>B000.Reviver.hash_file</code></a><code> (reviver m) f</code>. Note that these file hashes operations are memoized.</p></div></div><div><div class="spec value" id="val-stir" class="anchored"><a href="#val-stir" class="anchor"></a><code><span class="keyword">val</span> stir : <span>block:bool</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> unit</code></div><div><p><code>stir ~block m</code> runs the memoizer a bit. If <code>block</code> is <code>true</code> blocks until the memoizer is stuck with no operation and fibers to execute.</p></div></div><div><div class="spec value" id="val-status" class="anchored"><a href="#val-status" class="anchor"></a><code><span class="keyword">val</span> status : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>(unit, <a href="../../B000/Op/index.html#type-aggregate_error">B000.Op.aggregate_error</a>)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></span></code></div><div><p><code>status m</code> looks for aggregate errors in <code>m</code> in <code>ops m</code>, see <a href="../../B000/Op/index.html#type-aggregate_error"><code>B000.Op.aggregate_error</code></a> for details.</p><p>Usually called after a blocking <a href="index.html#val-stir"><code>stir</code></a> to check everything executed as expected. The function itself has no effect more operations can be on <code>m</code> afterwards. If you are only interested in checking if a failure occured in the memo <a href="index.html#val-has_failures"><code>has_failures</code></a> is faster.</p></div></div><div><div class="spec value" id="val-delete_trash" class="anchored"><a href="#val-delete_trash" class="anchor"></a><code><span class="keyword">val</span> delete_trash : <span>block:bool</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>(unit, string)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></span></code></div><div><p><code>delete_trash ~block m</code> is <a href="../../B000/Trash/index.html#val-delete"><code>B000.Trash.delete</code></a><code> ~block (trash m)</code>.</p></div></div><div><div class="spec value" id="val-ops" class="anchored"><a href="#val-ops" class="anchor"></a><code><span class="keyword">val</span> ops : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><a href="../../B000/Op/index.html#type-t">B000.Op.t</a> list</span></code></div><div><p><code>ops m</code> is the list of operations that were submitted to the memoizer</p></div></div><h2 id="marks"><a href="#marks" class="anchor"></a>Activity marks</h2><aside><p>Activity marks are just identifiers used for UI purposes to watermark the activity – notably build operations – occuring in the memo.</p></aside><div><div class="spec value" id="val-mark" class="anchored"><a href="#val-mark" class="anchor"></a><code><span class="keyword">val</span> mark : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> string</code></div><div><p><code>mark m</code> is <code>m</code>'s mark.</p></div></div><div><div class="spec value" id="val-with_mark" class="anchored"><a href="#val-with_mark" class="anchor"></a><code><span class="keyword">val</span> with_mark : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></div><div><p><code>mark m mark</code> is <code>m</code> but operations performed on <code>m</code> are marked by <code>mark</code>.</p></div></div><h2 id="fibers"><a href="#fibers" class="anchor"></a>Futures and fibers</h2><div><div class="spec type" id="type-fiber" class="anchored"><a href="#type-fiber" class="anchor"></a><code><span class="keyword">type</span> <span>'a fiber</span> = <span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> unit)</span> <span>&#45;&gt;</span> unit</code></div><div><p>The type for memoizer fibers returning values of type <code>'a</code>. A fiber <code>f k</code> represent a thread of execution that eventually kontinues <code>k</code> with its result value when it reaches an end.</p><p>Fibers should always be run on a Memo via <a href="index.html#val-spawn_fiber"><code>spawn_fiber</code></a> or as the continuation of a build operation. A fiber can fail either explictly via <a href="index.html#val-fail"><code>fail</code></a> or because an uncaught exception occurs. In both these cases a <code>`Fail</code> <a href="index.html#val-notify"><code>notify</code></a> operation gets added to the memo to witness the fiber failure. The status of this operation is like any <code>Fail</code> notify: <a href="../../B000/Op/index.html#type-status.Failed"><code>B000.Op.status.Failed</code></a>.</p></div></div><div><div class="spec value" id="val-spawn_fiber" class="anchored"><a href="#val-spawn_fiber" class="anchor"></a><code><span class="keyword">val</span> spawn_fiber : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>unit <a href="index.html#type-fiber">fiber</a></span></code></div><div><p><code>run m k</code> calls <code>k ()</code> asynchronously and handles any fiber <a href="index.html#val-fail"><code>fail</code></a>ure. This also catches non-asynchronous uncaught exceptions and turns them into <code>`Fail</code> notification operations.</p></div></div><div><div class="spec value" id="val-fail" class="anchored"><a href="#val-fail" class="anchor"></a><code><span class="keyword">val</span> fail : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, <a href="../../../ocaml/Stdlib/Format/index.html#type-formatter">Stdlib.Format.formatter</a>, unit, <span class="type-var">'b</span>)</span> <a href="../../../ocaml/Stdlib/index.html#type-format4">Stdlib.format4</a></span> <span>&#45;&gt;</span> <span class="type-var">'a</span></code></div><div><p><code>fail m fmt ...</code> fails the fiber via a <a href="index.html#val-notify"><code>notify</code></a> operation.</p></div></div><div><div class="spec value" id="val-fail_if_error" class="anchored"><a href="#val-fail_if_error" class="anchor"></a><code><span class="keyword">val</span> fail_if_error : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, string)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></span> <span>&#45;&gt;</span> <span class="type-var">'a</span></code></div><div><p><code>fail_if_error m r</code> is <code>v</code> if <code>r</code> is <code>Ok v</code> and <code>fail m &quot;%s&quot; e</code> if <code>r</code> is <code>Error _</code>.</p></div></div><div><div class="spec module" id="module-Fut" class="anchored"><a href="#module-Fut" class="anchor"></a><code><span class="keyword">module</span> <a href="Fut/index.html">Fut</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div><p>Future values.</p></div></div><h2 id="feedback"><a href="#feedback" class="anchor"></a>Feedback</h2><aside><p><b>XXX</b> This needs a bit of reviewing.</p></aside><div><div class="spec value" id="val-notify" class="anchored"><a href="#val-notify" class="anchor"></a><code><span class="keyword">val</span> notify : <span>?&#8288;k:<span>(unit <span>&#45;&gt;</span> unit)</span></span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>[ `Fail <span>| `Warn</span> <span>| `Start</span> <span>| `End</span> <span>| `Info</span> ]</span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, <a href="../../../ocaml/Stdlib/Format/index.html#type-formatter">Stdlib.Format.formatter</a>, unit, unit)</span> <a href="../../../ocaml/Stdlib/index.html#type-format4">Stdlib.format4</a></span> <span>&#45;&gt;</span> <span class="type-var">'a</span></code></div><div><p><code>notify m kind msg</code> is a notification <code>msg</code> of kind <code>kind</code>. Note that a <code>`Fail</code> notification will entail a <code>finish_error</code>, see also <a href="index.html#val-fail"><code>fail</code></a> and <a href="index.html#val-fail_if_error"><code>fail_if_error</code></a>.</p></div></div><div><div class="spec value" id="val-notify_if_error" class="anchored"><a href="#val-notify_if_error" class="anchor"></a><code><span class="keyword">val</span> notify_if_error : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>[ `Fail <span>| `Warn</span> <span>| `Start</span> <span>| `End</span> <span>| `Info</span> ]</span> <span>&#45;&gt;</span> <span>use:<span class="type-var">'a</span></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'a</span>, string)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></span> <span>&#45;&gt;</span> <span class="type-var">'a</span></code></div><div><p><code>notify_if_error m kind ~use r</code> is <code>v</code> if <code>r</code> is <code>Ok v</code>. If <code>r</code> is <code>Error e</code>, a notification of kind <code>kind</code> is added to <code>m</code> and <code>use</code> is returned. Note that a <code>`Fail</code> notification will entail a <code>finish_error</code>, see also <a href="index.html#val-fail"><code>fail</code></a> and <a href="index.html#val-fail_if_error"><code>fail_if_error</code></a>.</p></div></div><h2 id="files"><a href="#files" class="anchor"></a>Files and directories</h2><div><div class="spec value" id="val-file_ready" class="anchored"><a href="#val-file_ready" class="anchor"></a><code><span class="keyword">val</span> file_ready : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span>&#45;&gt;</span> unit</code></div><div><p><code>ready m p</code> declares path <code>p</code> to be ready, that is exists and is up-to-date in <code>b</code>. This is typically used with source files and files external to the build (e.g. installed libraries).</p></div></div><div><div class="spec value" id="val-read" class="anchored"><a href="#val-read" class="anchor"></a><code><span class="keyword">val</span> read : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span>&#45;&gt;</span> <span>string <a href="index.html#type-fiber">fiber</a></span></code></div><div><p><code>read m file k</code> reads the contents of file <code>file</code> as <code>s</code> when it becomes ready and continues with <code>k s</code>.</p></div></div><div><div class="spec value" id="val-write" class="anchored"><a href="#val-write" class="anchor"></a><code><span class="keyword">val</span> write : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>?&#8288;stamp:string</span> <span>&#45;&gt;</span> <span>?&#8288;reads:<span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> list</span></span> <span>&#45;&gt;</span> <span>?&#8288;mode:int</span> <span>&#45;&gt;</span> <a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span>&#45;&gt;</span> <span>(unit <span>&#45;&gt;</span> <span><span>(string, string)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></span>)</span> <span>&#45;&gt;</span> unit</code></div><div><p><code>write m ~reads file w</code> writes <code>file</code> with data <code>w ()</code> and mode <code>mode</code> (defaults to <code>0o644</code>) when <code>reads</code> are ready. <code>w</code>'s result must only depend on <code>reads</code> and <code>stamp</code> (defaults to <code>&quot;&quot;</code>).</p></div></div><div><div class="spec value" id="val-copy" class="anchored"><a href="#val-copy" class="anchor"></a><code><span class="keyword">val</span> copy : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>?&#8288;mode:int</span> <span>&#45;&gt;</span> <span>?&#8288;linenum:int</span> <span>&#45;&gt;</span> <span>src:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a></span> <span>&#45;&gt;</span> <a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span>&#45;&gt;</span> unit</code></div><div><p><code>copy m ~mode ?linenum ~src dst</code> copies file <code>src</code> to <code>dst</code> with mode <code>mode</code> (defaults to <code>0o644</code>) when <code>src</code> is ready. If <code>linenum</code> is specified, the following line number directive is prependend in <code>dst</code> to the contents of <code>src</code>:</p><pre><code>#line $(linenum) &quot;$(src)&quot;</code></pre></div></div><div><div class="spec value" id="val-mkdir" class="anchored"><a href="#val-mkdir" class="anchor"></a><code><span class="keyword">val</span> mkdir : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>?&#8288;mode:int</span> <span>&#45;&gt;</span> <a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span>&#45;&gt;</span> <span>unit <a href="index.html#type-fiber">fiber</a></span></code></div><div><p><code>mkdir m dir p</code> creates the directory path <code>p</code> with <code>mode</code> <code>mode</code> (defaults to <code>0o755</code>) and continues with <code>k ()</code> whne <code>dir</code> is available. The behaviour with respect to file permission matches <code>Os</code>.Dir.create.</p></div></div><div><div class="spec value" id="val-delete" class="anchored"><a href="#val-delete" class="anchor"></a><code><span class="keyword">val</span> delete : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> <span>&#45;&gt;</span> <span>unit <a href="index.html#type-fiber">fiber</a></span></code></div><div><p><code>delete m p</code> deletes (trashes in fact) path <code>p</code> and continues with <code>k ()</code> when the path <code>p</code> is free to use.</p></div></div><div><div class="spec value" id="val-wait_files" class="anchored"><a href="#val-wait_files" class="anchor"></a><code><span class="keyword">val</span> wait_files : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> list</span> <span>&#45;&gt;</span> <span>unit <a href="index.html#type-fiber">fiber</a></span></code></div><div><p><code>wait_files m files k</code> continues with <code>k ()</code> when <code>files</code> become ready. <b>FIXME</b> Unclear whether we really want this.</p></div></div><h2 id="spawn"><a href="#spawn" class="anchor"></a>Memoizing tool spawns</h2><div><div class="spec type" id="type-tool" class="anchored"><a href="#type-tool" class="anchor"></a><code><span class="keyword">type</span> tool</code></div><div><p>The type for memoized tools.</p></div></div><div><div class="spec type" id="type-cmd" class="anchored"><a href="#type-cmd" class="anchor"></a><code><span class="keyword">type</span> cmd</code></div><div><p>The type for memoized tool invocations.</p></div></div><div><div class="spec value" id="val-tool" class="anchored"><a href="#val-tool" class="anchor"></a><code><span class="keyword">val</span> tool : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../Tool/index.html#type-t">Tool.t</a> <span>&#45;&gt;</span> <a href="../../B00_std/Cmd/index.html#type-t">B00_std.Cmd.t</a> <span>&#45;&gt;</span> <a href="index.html#type-cmd">cmd</a></code></div><div><p><code>tool m t</code> is tool <code>t</code> memoized. Use the resulting function to spawn the tool with the given arguments.</p></div></div><div><div class="spec value" id="val-tool_opt" class="anchored"><a href="#val-tool_opt" class="anchor"></a><code><span class="keyword">val</span> tool_opt : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../Tool/index.html#type-t">Tool.t</a> <span>&#45;&gt;</span> <span><span>(<a href="../../B00_std/Cmd/index.html#type-t">B00_std.Cmd.t</a> <span>&#45;&gt;</span> <a href="index.html#type-cmd">cmd</a>)</span> option</span></code></div><div><p><code>tool_opt m t</code> is like <a href="index.html#val-tool"><code>tool</code></a>, except <code>None</code> is returned if the tool cannot be found.</p></div></div><div><div class="spec value" id="val-spawn" class="anchored"><a href="#val-spawn" class="anchor"></a><code><span class="keyword">val</span> spawn : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>?&#8288;stamp:string</span> <span>&#45;&gt;</span> <span>?&#8288;reads:<span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> list</span></span> <span>&#45;&gt;</span> <span>?&#8288;writes:<span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> list</span></span> <span>&#45;&gt;</span> <span>?&#8288;env:<a href="../../B00_std/Os/Env/index.html#type-t">B00_std.Os.Env.t</a></span> <span>&#45;&gt;</span> <span>?&#8288;cwd:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a></span> <span>&#45;&gt;</span> <span>?&#8288;stdin:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a></span> <span>&#45;&gt;</span> <span>?&#8288;stdout:<a href="../../B000/Op/Spawn/index.html#type-stdo">B000.Op.Spawn.stdo</a></span> <span>&#45;&gt;</span> <span>?&#8288;stderr:<a href="../../B000/Op/Spawn/index.html#type-stdo">B000.Op.Spawn.stdo</a></span> <span>&#45;&gt;</span> <span>?&#8288;success_exits:<a href="../../B000/Op/Spawn/index.html#type-success_exits">B000.Op.Spawn.success_exits</a></span> <span>&#45;&gt;</span> <span>?&#8288;post_exec:<span>(<a href="../../B000/Op/index.html#type-t">B000.Op.t</a> <span>&#45;&gt;</span> unit)</span></span> <span>&#45;&gt;</span> <span>?&#8288;k:<span>(int <span>&#45;&gt;</span> unit)</span></span> <span>&#45;&gt;</span> <a href="index.html#type-cmd">cmd</a> <span>&#45;&gt;</span> unit</code></div><div><p><code>spawn m ~reads ~writes ~env ~cwd ~stdin ~stdout ~stderr
      ~success_exits cmd</code> spawns <code>cmd</code> once <code>reads</code> files are ready and makes files <code>writes</code> ready if the spawn succeeds and the file exists. The rest of the arguments are:</p><ul><li><code>stdin</code> reads input from the given file. If unspecified reads from the standard input of the program running the build. <b>Warning.</b> The file is not automatically added to <code>reads</code>, this allows for example to use <a href="../../B00_std/Os/File/index.html#val-null"><code>B00_std.Os.File.null</code></a>.</li><li><code>stdout</code> and <code>stderr</code>, the redirections for the standard outputs of the command, see <code>stdo</code>. Path to files are created if needed. <b>Warning.</b> File redirections are not automatically added to <code>writes</code>; this allows for example to use <a href="../../B00_std/Os/File/index.html#val-null"><code>B00_std.Os.File.null</code></a>.</li><li><code>success_exits</code> the exit codes that determine if the build operation is successful (defaults to <code>0</code>, use <code>[]</code> to always succeed)</li><li><code>env</code>, environment variables added to the build environment. This overrides environment variables read by the tool in the build environment except for forced one. It also allows to specify environment that may not be mentioned by the running tool's <a href="../Tool/index.html#val-v">environment specification</a>.</li><li><code>cwd</code> the current working directory. Default is <code>cwd</code>. In general it's better to avoid using relative file paths and tweaking the <code>cwd</code>. Construct your paths using the absolute <span class="xref-unresolved">directory functions</span> and make your invocations independent from the <code>cwd</code>.</li><li><code>post_exec</code>, if specified is called with the build operation after it has been executed or revived. If it was executed this is called before the operation gets recorded. It can be used to define the <code>reads</code> and <code>writes</code> of the operation if they are difficult to find out before hand. <b>Do not</b> access <code>m</code> in that function.</li><li><code>k</code>, if specified a fiber invoked once the spawn has succesfully executed with the exit code.</li><li><code>stamp</code> is used for caching if two spawns diff only in their stamp they will cache to different keys. This can be used to memoize tool whose outputs may not entirely depend on the environment, the cli stamp and the the content of read files.</li></ul><p><b>Note.</b> If the tool spawn acts on a sort of &quot;main&quot; file (e.g. a source file) it should be specified as the first element of <code>reads</code>, this is interpreted specially by certain build tracer.</p></div></div><div><div class="spec value" id="val-spawn'" class="anchored"><a href="#val-spawn'" class="anchor"></a><code><span class="keyword">val</span> spawn' : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>?&#8288;stamp:string</span> <span>&#45;&gt;</span> <span>?&#8288;reads:<span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> list</span></span> <span>&#45;&gt;</span> <span>writes_root:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a></span> <span>&#45;&gt;</span> <span>?&#8288;writes:<span>(<a href="../../B000/Op/index.html#type-t">B000.Op.t</a> <span>&#45;&gt;</span> <span><a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a> list</span>)</span></span> <span>&#45;&gt;</span> <span>?&#8288;env:<a href="../../B00_std/Os/Env/index.html#type-t">B00_std.Os.Env.t</a></span> <span>&#45;&gt;</span> <span>?&#8288;cwd:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a></span> <span>&#45;&gt;</span> <span>?&#8288;stdin:<a href="../../B00_std/Fpath/index.html#type-t">B00_std.Fpath.t</a></span> <span>&#45;&gt;</span> <span>?&#8288;stdout:<a href="../../B000/Op/Spawn/index.html#type-stdo">B000.Op.Spawn.stdo</a></span> <span>&#45;&gt;</span> <span>?&#8288;stderr:<a href="../../B000/Op/Spawn/index.html#type-stdo">B000.Op.Spawn.stdo</a></span> <span>&#45;&gt;</span> <span>?&#8288;success_exits:<a href="../../B000/Op/Spawn/index.html#type-success_exits">B000.Op.Spawn.success_exits</a></span> <span>&#45;&gt;</span> <span>?&#8288;k:<span>(int <span>&#45;&gt;</span> unit)</span></span> <span>&#45;&gt;</span> <a href="index.html#type-cmd">cmd</a> <span>&#45;&gt;</span> unit</code></div><div><p><code>spawn'</code> is like <a href="index.html#val-spawn"><code>spawn</code></a> except the actual file paths written by the spawn need not be determined before the spawn. Only the root directory of writes need to be specified via <code>writes_root</code>. After the spawn executes the writes can be determined via the <code>writes</code> function, the returned paths must be absolute and be prefixed by <code>writes_root</code> (defaults to recursively list all the files rootet in <code>writes_root</code>).</p></div></div></div></body></html>