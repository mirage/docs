<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>manual (b0.manual)</title><link rel="stylesheet" href="../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc v1.1.1-1373-g2e7c1c75"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><nav><a href="index.html">Up</a> â€“ <a href="index.html">b0</a> &#x00BB; manual</nav><header><h1 id="b0-manual"><a href="#b0-manual" class="anchor"></a>B0 manual</h1><p>This manual provides a conceptual overview of the B0 system and explains the basic mechanics of B0 files and their definitions. See <span class="xref-unresolved">here</span> for other topics.</p></header><nav class="toc"><ul><li><a href="#intro">Introduction</a></li><li><a href="#b0_file">B0 files</a><ul><li><a href="#root_b0_file">Root B0 file</a></li><li><a href="#root_dir">Root and <code>_b0</code> directory</a></li><li><a href="#rel_paths">Relative file paths</a></li><li><a href="#inclusion">Including B0 files</a><ul><li><a href="#scope">Scopes</a></li><li><a href="#access">Access control and isolation</a></li><li><a href="#vendoring">Dependency vendoring</a></li></ul></li><li><a href="#libs">Using libraries</a></li><li><a href="#boot">B0 file bootstrap</a></li></ul></li><li><a href="#definitions">B0 file definitions</a><ul><li><a href="#meta">Metadata</a></li><li><a href="#units">Build units</a></li><li><a href="#packs">Build packs</a><ul><li><a href="#default_pack">The <code>default</code> pack</a></li></ul></li><li><a href="#envs">Build environments</a><ul><li><a href="#default_env">The <code>default</code> environment</a></li><li><a href="#user_env">The <code>user</code> environment</a></li></ul></li><li><a href="#actions">Actions</a></li></ul></li><li><a href="#b0_file_reference">B0 file reference</a><ul><li><a href="#b0_file_syntax">Syntax</a></li><li><a href="#directives">Directives</a><ul><li><a href="#directive_boot">Directive <code>@@@B0.boot</code></a></li><li><a href="#directive_include">Directive <code>@@@B0.include</code></a></li><li><a href="#directive_require">Directive <code>#require</code></a></li></ul></li></ul></li></ul></nav><div class="content"><h2 id="intro"><a href="#intro" class="anchor"></a>Introduction</h2><p>B0 aims at liberating the programmer from the essential but often tedious and brittle bureaucracy that surrounds the programming activity. It provides a framework with a decent description language to devise modular and custom solutions to software construction and deployment problems.</p><p>B0 describes:</p><ul><li>Build environments.</li><li>Software configuration, build and testing.</li><li>Source or built artefact deployments.</li><li>Development life-cycle procedures and actions.</li></ul><p>These descriptions are made in <em>B0 files</em> which we describe next.</p><h2 id="b0_file"><a href="#b0_file" class="anchor"></a>B0 files</h2><p>A B0 file is a syntactically valid OCaml file possibly prefixed by a few <span class="xref-unresolved">directives</span>. The OCaml code creates definitions to describe the software by using the versioned <a href="../b0/B0_kit/index.html"><code>B0_kit</code></a> API and possibly other third-party OCaml <span class="xref-unresolved">libraries</span>.</p><p>Usually B0 files are named <code>B0.ml</code> and are found at the root of a project's source tree. It centralizes the definitions that describe the software.</p><p>The definitions in B0 files are consulted and processed by <em>drivers</em>. The <code>b0</code> and <code>d0</code> tools distributed with B0 are examples of drivers. An API is provided to create custom driver, see the <a href="../b0/driver_dev">B0 driver development manual</a>.</p><h3 id="root_b0_file"><a href="#root_b0_file" class="anchor"></a>Root B0 file</h3><p>The B0 file executed by a driver is called the <em>root B0 file</em>. When a driver like <code>b0</code> is invoked in a directory <code>cwd</code>, the root B0 file is the <em>first</em> <code>B0.ml</code> file found starting at the <code>cwd</code> and moving upwards in parent directories.</p><p>The root B0 file can also be specified explicitely via the <code>--b0-file</code> option or the <code>B0_FILE</code> environment variable. Invoke <code>b0 file path</code> to find out which root B0 file is determined by <code>b0</code>.</p><h3 id="root_dir"><a href="#root_dir" class="anchor"></a>Root and <code>_b0</code> directory</h3><p>The <em>root directory</em> is the directory in which the <span class="xref-unresolved">root B0 file</span> is found. Most of the time the root directory coincides with the root of the project's source tree. However in case a root B0 file simply gathers multiple project definitions by <span class="xref-unresolved">including</span> B0 files the root directory may be empty.</p><p>The root directory is where the scratchable <em><code>_b0</code> directory</em> used by drivers to operate and store their results gets created by default. The location of the <code>_b0</code> directory can also be specified explicitely via the <code>--b0-dir</code> option or the <code>B0_DIR</code> environment variable. <code>_b0</code> directories should be ignored by version control systems.</p><h3 id="rel_paths"><a href="#rel_paths" class="anchor"></a>Relative file paths</h3><p>Unless otherwise indicated relative file paths specified in definitions and directives of a B0 file are <em>always</em> relative to the directory where the B0 file lies.</p><h3 id="inclusion"><a href="#inclusion" class="anchor"></a>Including B0 files</h3><p>The <span class="xref-unresolved"><code>@@@B0.include</code></span> directive provides a mecanism to compose B0 files. The intent of B0 file inclusion is to be able to aggregate independent software (sub)systems or to vendor dependencies. Include directives must be specified <em>at the start</em> of a B0 file, before comments or OCaml code.</p><p>For example the following <code>B0.ml</code> file includes the definitions of two other B0 files:</p><pre><code>[@@@B0.include &quot;that&quot; &quot;../that-lib/B0.ml&quot;]
[@@@B0.include &quot;projects/proj/B0.ml&quot;]</code></pre><h4 id="scope"><a href="#scope" class="anchor"></a>Scopes</h4><p>An included B0 file defines a named <em>scope</em> to which its definitions are added. Scope names are either specified explicitely or automatically derived from the directory name of the B0 file. In the example above the scope names are, in order, <code>that</code> and <code>proj</code>.</p><p>From the B0 file that includes, the syntax to access a definition named <code>d</code> in a scope <code>s</code> is <code>s.d</code>.</p><p>Scope names must be unique in a given B0 file and must not contain <code>'.'</code> characters. The <code>lib</code> scope name is reserved and can't be used (bof change that). It is used as a root scope for library definitions. If these constraints are not satisfied the B0 file errors.</p><h4 id="access"><a href="#access" class="anchor"></a>Access control and isolation</h4><p>At definition time a B0 file can only access definitions that are in its own scope or in the scope of the files it <code>@B00.include</code>s and recursively. This means that in any B0 file:</p><pre><code>let all_units = B0_unit.list () (* get all units defined so far *)</code></pre><p>the value <code>all_units</code> depends only on the definitions and includes of the B0 file itself, however included it may itself be.</p><p>In the example above the two included B0 files cannot refer to the names of the other directly at definition time. However at build time their definitions may interact indirectly via metadata and build logic name resolution procedures which have access to the global scope, see <code>vendoring</code>.</p><p>The <em>OCaml language</em> scope of included files is not accessible and always fully isolated. Both includer and includee cannot access each other's OCaml identifiers.</p><h4 id="vendoring"><a href="#vendoring" class="anchor"></a>Dependency vendoring</h4><p>Support for build dependency vendoring depends on the name resolution procedure of the build logic you are using.</p><p>If the build logic you use is able to look in the definitions of the root B0 file for dependencies and use these instead of those found in the build environment then vendoring is simply a matter of <code>@@@B0.includ</code>ing the definitions of the dependencies to your B0 file.</p><p>A typical setup is to have at the root of a project:</p><pre>B0.ml
vendor/dep1/
vendor/dep2/
src/</pre><p>and to start your project's <code>B0.ml</code> file with:</p><pre><code>[@@@B0.include &quot;vendor/dep1/B0.ml&quot;]
[@@@B0.include &quot;vendor/dep2/B0.ml&quot;]
...</code></pre><p>Since dependencies may have vendored dependencies themselves, coherence issues may arise. You may have to define new consistent and locked <span class="xref-unresolved">build packs</span> in the root B0 file in order to exclude conflicting dependencies.</p><h3 id="libs"><a href="#libs" class="anchor"></a>Using libraries</h3><p>B0 is a modular and extensible system. It is <em>expected</em> for third-parties to define build and deployment logics and distribute them as libraries.</p><p>Any OCaml library available in the <code>OCAMLPATH</code> can be used in a B0 file by requiring it via the <span class="xref-unresolved">#require</span> directive. <code>#require</code> directives must be specified <em>at the start</em> of the file, before comments or OCaml code.</p><p>For example:</p><pre><code>#require &quot;mylib&quot;</code></pre><p>instructs to lookup library <code>mylib</code> in the <code>OCAMLPATH</code> and use it to compile the B0 file.</p><h3 id="boot"><a href="#boot" class="anchor"></a>B0 file bootstrap</h3><p>A B0 file is an OCaml source and may need <span class="xref-unresolved">additional</span> OCaml libraries. This means it needs an OCaml compiler in the user <code>PATH</code> and the <code>#require</code>d libraries in the <code>OCAMLPATH</code>.</p><p>Making sure these libraries are available is the purpose of B0 file boostrapping. The <span class="xref-unresolved"><code>@@@B0.boot</code></span> directive allows to specify a system to run in order to install the B0 file prerequistes.</p><p>For example the following directive:</p><pre><code>[@@@B0.boot &quot;opam&quot; &quot;my-logic&gt;=1.0.0&quot;]</code></pre><p>indicates the B0 file needs the <code>my-logic</code> package to be installed with version greater or equal than 1.0.0. The syntax for opam package names and constraints follows that of the <code>opam install</code> command.</p><p>This declaration allows to install the B0 file prerequisites by invoking:</p><pre><code>b0 file boot --opam</code></pre><h2 id="definitions"><a href="#definitions" class="anchor"></a>B0 file definitions</h2><p>This section provides a high-level view of the definitions made in B0 files to describe the software.</p><p>B0 definitions are named and <em>static</em>. The latter means they need to be defined during the initialisation of the B0 file. This allows end-user to query and act upon them from user interfaces like the command line.</p><h3 id="meta"><a href="#meta" class="anchor"></a>Metadata</h3><p>All definitions in B0 have a metadata dictionary of type <a href="../b0/B0_meta/index.html#type-t"><code>B0_meta.t</code></a> attached. Metadata is used to drive build logics and inform actions and deployments.</p><p>The type <a href="../b0/B0_meta/index.html#type-t"><code>B0_meta.t</code></a> is a simple type-safe heterogenous value map. A few <a href="../b0/B0_meta/index.html#std">standard keys</a> are provided, consider using these before defining your own. Also consult <a href="../b0/B0_kit/index.html"><code>B0_kit</code></a> and libraries of build logic which may define more.</p><h3 id="units"><a href="#units" class="anchor"></a>Build units</h3><p>A build unit gathers sets of related low-level build operations (e.g. tool spawns). Typical build units are sequences of commands that build a library, an executable, etc.</p><p>Build units structure builds in well identified fragments, they form the smallest unit of build that can be be requested for building by the user.</p><p>They are given a build directory in <code>_b0</code> according to the build environment and their name where they <em>should</em>, but are not required to output their results.</p><h3 id="packs"><a href="#packs" class="anchor"></a>Build packs</h3><p>A build pack gathers a set of <span class="xref-unresolved">build units</span>. Build packs have no formal operational functionality in the system. It is just a way to list build units under a name and perform coarse grained actions on them. Note that a build unit can belong to more than one pack.</p><p>Here are example of pack usage in the system:</p><ul><li>Define convenience subsets, possibly locked, of units to build. These builds can then be easily triggered via the <code>-p</code> option of <code>b0 build</code>.</li><li>Define metadata and build units to create a distribution package. For example opam package descriptions can be generated from build packs.</li><li>Define build prerequisites for actions and deployments</li></ul><h4 id="default_pack"><a href="#default_pack" class="anchor"></a>The <code>default</code> pack</h4><p>The <code>default</code> pack defines the build units that are built when a bare <code>b0 build</code> is invoked.</p><h3 id="envs"><a href="#envs" class="anchor"></a>Build environments</h3><h4 id="default_env"><a href="#default_env" class="anchor"></a>The <code>default</code> environment</h4><h4 id="user_env"><a href="#user_env" class="anchor"></a>The <code>user</code> environment</h4><h3 id="actions"><a href="#actions" class="anchor"></a>Actions</h3><h2 id="b0_file_reference"><a href="#b0_file_reference" class="anchor"></a>B0 file reference</h2><p>The following parts can be distinguished in a B0 file:</p><ol><li>The initial sequence of <span class="xref-unresolved">directives</span>. Before any comment or OCaml construct.</li><li>The OCaml unit implementation.</li></ol><p>The order is important. Directives that are mentioned after the OCaml unit implementation starts are either silently ignored (<code>@@@B0.*</code> directives) or produce compilation errors (<code>#*</code> directives).</p><h3 id="b0_file_syntax"><a href="#b0_file_syntax" class="anchor"></a>Syntax</h3><p>A B0 file is white space (no comments) separated directives followed by an <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.09/compunit.html#unit-implementation">OCaml unit implementation</a>.</p><p>Using an <a href="https://tools.ietf.org/html/rfc5234">RFC 5234</a> grammar this reads as:</p><pre>b0_file    = *(ws directive) ws unit-implementation
directive  = dir-boot / dir-inc / dir-req
dir-boot   = &quot;[@@@B0.boot&quot; *(ws dstring) ws &quot;]&quot;
dir-inc    = &quot;[@@@B0.include&quot; *(ws dstring) ws &quot;]&quot;
dir-req    = &quot;#require&quot; ws dstring
dstring    = %x22 dchar *dchar %x22
dchar      = escape / cont / ws / %x21 / %x23-%x5B / %x5D-%x7E / %x80-xFF
escape     = %x5C (%x20 / %x22 / %x5C)
cont       = %x5C nl ws
ws         = *(%x20 / %x09 / %x0A / %x0B / %x0C / %x0D)
nl         = %x0A / %x0D / %x0D %x0A
unit-implementation = ... ; See the syntax in the OCaml manual</pre><h3 id="directives"><a href="#directives" class="anchor"></a>Directives</h3><h4 id="directive_boot"><a href="#directive_boot" class="anchor"></a>Directive <code>@@@B0.boot</code></h4><p>The syntax of the <code>@@@B0.boot</code> directive is:</p><pre><code>[@@@B0.boot &quot;SYSTEM&quot; &quot;ARG&quot;... ]</code></pre><p>At the moment the only known value for <code>&quot;SYSTEM&quot;</code> is <code>&quot;opam&quot;</code> and its argument names are packages constraints using the same syntax as the <code>opam install</code> command:</p><pre><code>[@@@B0.boot &quot;opam&quot; &quot;PKG&quot;... ]</code></pre><p>This indicates the <code>opam</code> package <code>PKG</code> need to be installed in order to compile the B0 file.</p><h4 id="directive_include"><a href="#directive_include" class="anchor"></a>Directive <code>@@@B0.include</code></h4><p>The syntax of the <code>@@@B0.include</code> directive is one of:</p><pre><code>[@@@B0.include &quot;PATH&quot;]
[@@@B0.include &quot;NAME&quot; &quot;PATH&quot;]</code></pre><p>The semantics is to include in the B0 file the definitions of the B0 file at <code>&quot;PATH&quot;</code> in a scope named <code>&quot;NAME&quot;</code>. If <code>&quot;NAME&quot;</code> is is not specified the directory name of the included B0 file is used.</p><p><code>&quot;NAME&quot;</code> must be unique among the B0 files included in the file and must not contain <code>'.'</code> characters.</p><h4 id="directive_require"><a href="#directive_require" class="anchor"></a>Directive <code>#require</code></h4><p>The syntax of the <code>#require</code> directive is:</p><pre><code>#require &quot;LIB&quot;</code></pre><p>The semantics is to compile and link the B0 file against library <code>LIB</code>, looked up in the <code>OCAMLPATH</code>. At the moment library <code>LIB</code>'s dependencies must be manually <code>#required</code> aswell.</p></div></body></html>