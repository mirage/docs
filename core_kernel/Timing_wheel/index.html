<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Timing_wheel (core_kernel.Timing_wheel)</title><link rel="stylesheet" href="../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc v1.1.1-1373-g2e7c1c75"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">core_kernel</a> &#x00BB; Timing_wheel</nav><header><h1>Module <code>Timing_wheel</code></h1></header><div class="content"><div><div class="spec include"><div class="doc"><div class="spec module" id="module-Alarm_precision" class="anchored"><a href="#module-Alarm_precision" class="anchor"></a><code><span class="keyword">module</span> <a href="Alarm_precision/index.html">Alarm_precision</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> <span>'a t</span></code></div><div><div class="spec include"><div class="doc"><div class="spec value" id="val-sexp_of_t" class="anchored"><a href="#val-sexp_of_t" class="anchor"></a><code><span class="keyword">val</span> sexp_of_t : <span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> <a href="../../sexplib0/Sexplib0/Sexp/index.html#type-t">Ppx_sexp_conv_lib.Sexp.t</a>)</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../../sexplib0/Sexplib0/Sexp/index.html#type-t">Ppx_sexp_conv_lib.Sexp.t</a></code></div></div></div></div><div class="spec type" id="type-timing_wheel" class="anchored"><a href="#type-timing_wheel" class="anchor"></a><code><span class="keyword">type</span> <span>'a timing_wheel</span> = <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span></code></div><div><div class="spec type" id="type-t_now" class="anchored"><a href="#type-t_now" class="anchor"></a><code><span class="keyword">type</span> <span>'a t_now</span> = <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span></code></div><div><p><code>&lt;:sexp_of&lt; _ t_now &gt;&gt;</code> displays only <code>now t</code>, not all the alarms.</p></div></div><div><div class="spec include"><div class="doc"><div class="spec value" id="val-sexp_of_t_now" class="anchored"><a href="#val-sexp_of_t_now" class="anchor"></a><code><span class="keyword">val</span> sexp_of_t_now : <span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> <a href="../../sexplib0/Sexplib0/Sexp/index.html#type-t">Ppx_sexp_conv_lib.Sexp.t</a>)</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t_now">t_now</a></span> <span>&#45;&gt;</span> <a href="../../sexplib0/Sexplib0/Sexp/index.html#type-t">Ppx_sexp_conv_lib.Sexp.t</a></code></div></div></div></div><div class="spec module" id="module-Interval_num" class="anchored"><a href="#module-Interval_num" class="anchor"></a><code><span class="keyword">module</span> <a href="Interval_num/index.html">Interval_num</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Alarm" class="anchored"><a href="#module-Alarm" class="anchor"></a><code><span class="keyword">module</span> <a href="Alarm/index.html">Alarm</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div><div class="spec include"><div class="doc"><details open="open"><summary><span class="def"><code><span class="keyword">include</span> <a href="../../base/Base/Invariant/module-type-S1/index.html">Core_kernel.Invariant.S1</a> <span class="keyword">with</span> <span class="keyword">type</span> <span>'a <a href="../../base/Base/Invariant/module-type-S1/index.html#type-t">t</a></span> := <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span></code></span></summary><div class="spec value" id="val-invariant" class="anchored"><a href="#val-invariant" class="anchor"></a><code><span class="keyword">val</span> invariant : <span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> unit)</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> unit</code></div></details></div></div></div><div class="spec module" id="module-Level_bits" class="anchored"><a href="#module-Level_bits" class="anchor"></a><code><span class="keyword">module</span> <a href="Level_bits/index.html">Level_bits</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Config" class="anchored"><a href="#module-Config" class="anchor"></a><code><span class="keyword">module</span> <a href="Config/index.html">Config</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div><div class="spec value" id="val-create" class="anchored"><a href="#val-create" class="anchor"></a><code><span class="keyword">val</span> create : <span>config:<a href="Config/index.html#type-t">Config.t</a></span> <span>&#45;&gt;</span> <span>start:<a href="../Core_kernel/Time_ns/index.html#type-t">Core_kernel.Time_ns.t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span></code></div><div><p><code>create ~config ~start</code> creates a new timing wheel with current time <code>start</code>. <code>create</code> raises if <code>start &lt; Time_ns.epoch</code>. For a fixed <code>level_bits</code>, a smaller (i.e. more precise) <code>alarm_precision</code> decreases the representable range of times/keys and increases the constant factor for <code>advance_clock</code>.</p></div></div><div><div class="spec value" id="val-alarm_precision" class="anchored"><a href="#val-alarm_precision" class="anchor"></a><code><span class="keyword">val</span> alarm_precision : <span><span class="type-var">_</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../Core_kernel/Time_ns/Span/index.html#type-t">Core_kernel.Time_ns.Span.t</a></code></div><div><p>Accessors</p></div></div><div class="spec value" id="val-now" class="anchored"><a href="#val-now" class="anchor"></a><code><span class="keyword">val</span> now : <span><span class="type-var">_</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../Core_kernel/Time_ns/index.html#type-t">Core_kernel.Time_ns.t</a></code></div><div class="spec value" id="val-start" class="anchored"><a href="#val-start" class="anchor"></a><code><span class="keyword">val</span> start : <span><span class="type-var">_</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../Core_kernel/Time_ns/index.html#type-t">Core_kernel.Time_ns.t</a></code></div><aside><p>One can think of a timing wheel as a set of alarms. Here are various container functions along those lines.</p></aside><div class="spec value" id="val-is_empty" class="anchored"><a href="#val-is_empty" class="anchor"></a><code><span class="keyword">val</span> is_empty : <span><span class="type-var">_</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> bool</code></div><div class="spec value" id="val-length" class="anchored"><a href="#val-length" class="anchor"></a><code><span class="keyword">val</span> length : <span><span class="type-var">_</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> int</code></div><div class="spec value" id="val-iter" class="anchored"><a href="#val-iter" class="anchor"></a><code><span class="keyword">val</span> iter : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span>f:<span>(<span><span class="type-var">'a</span> <a href="Alarm/index.html#type-t">Alarm.t</a></span> <span>&#45;&gt;</span> unit)</span></span> <span>&#45;&gt;</span> unit</code></div><div><div class="spec value" id="val-interval_num" class="anchored"><a href="#val-interval_num" class="anchor"></a><code><span class="keyword">val</span> interval_num : <span><span class="type-var">_</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../Core_kernel/Time_ns/index.html#type-t">Core_kernel.Time_ns.t</a> <span>&#45;&gt;</span> <a href="Interval_num/index.html#type-t">Interval_num.t</a></code></div><div><p><code>interval_num t time</code> returns the number of the interval that <code>time</code> is in, where <code>0</code> is the interval that starts at <code>Time_ns.epoch</code>. <code>interval_num</code> raises if <code>Time_ns.( &lt; ) time Time_ns.epoch</code>.</p></div></div><div><div class="spec value" id="val-now_interval_num" class="anchored"><a href="#val-now_interval_num" class="anchor"></a><code><span class="keyword">val</span> now_interval_num : <span><span class="type-var">_</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="Interval_num/index.html#type-t">Interval_num.t</a></code></div><div><p><code>now_interval_num t = interval_num t (now t)</code>.</p></div></div><div><div class="spec value" id="val-interval_num_start" class="anchored"><a href="#val-interval_num_start" class="anchor"></a><code><span class="keyword">val</span> interval_num_start : <span><span class="type-var">_</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="Interval_num/index.html#type-t">Interval_num.t</a> <span>&#45;&gt;</span> <a href="../Core_kernel/Time_ns/index.html#type-t">Core_kernel.Time_ns.t</a></code></div><div><p><code>interval_num_start t n</code> is the start of the <code>n</code>'th interval in <code>t</code>, i.e. <code>n * alarm_precision t</code> after the epoch.</p><p><code>interval_start t time</code> is the start of the half-open interval containing <code>time</code>, i.e.:</p><pre><code>interval_num_start t (interval_num t time)</code></pre></div></div><div><div class="spec value" id="val-interval_start" class="anchored"><a href="#val-interval_start" class="anchor"></a><code><span class="keyword">val</span> interval_start : <span><span class="type-var">_</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../Core_kernel/Time_ns/index.html#type-t">Core_kernel.Time_ns.t</a> <span>&#45;&gt;</span> <a href="../Core_kernel/Time_ns/index.html#type-t">Core_kernel.Time_ns.t</a></code></div><div><p><code>interval_start</code> raises in the same cases that <code>interval_num</code> does.</p></div></div><div><div class="spec value" id="val-advance_clock" class="anchored"><a href="#val-advance_clock" class="anchor"></a><code><span class="keyword">val</span> advance_clock : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span>to_:<a href="../Core_kernel/Time_ns/index.html#type-t">Core_kernel.Time_ns.t</a></span> <span>&#45;&gt;</span> <span>handle_fired:<span>(<span><span class="type-var">'a</span> <a href="Alarm/index.html#type-t">Alarm.t</a></span> <span>&#45;&gt;</span> unit)</span></span> <span>&#45;&gt;</span> unit</code></div><div><p><code>advance_clock t ~to_ ~handle_fired</code> advances <code>t</code>'s clock to <code>to_</code>. It fires and removes all alarms <code>a</code> in <code>t</code> with <code>Time_ns.(&lt;) (Alarm.at t a) (interval_start t
      to_)</code>, applying <code>handle_fired</code> to each such <code>a</code>.</p><p>If <code>to_ &lt;= now t</code>, then <code>advance_clock</code> does nothing.</p><p><code>advance_clock</code> fails if <code>to_</code> is too far in the future to represent.</p><p>Behavior is unspecified if <code>handle_fired</code> accesses <code>t</code> in any way other than <code>Alarm</code> functions.</p></div></div><div><div class="spec value" id="val-fire_past_alarms" class="anchored"><a href="#val-fire_past_alarms" class="anchor"></a><code><span class="keyword">val</span> fire_past_alarms : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span>handle_fired:<span>(<span><span class="type-var">'a</span> <a href="Alarm/index.html#type-t">Alarm.t</a></span> <span>&#45;&gt;</span> unit)</span></span> <span>&#45;&gt;</span> unit</code></div><div><p><code>fire_past_alarms t ~handle_fired</code> fires and removes all alarms <code>a</code> in <code>t</code> with <code>Time_ns.( &lt;= ) (Alarm.at t a) (now t)</code>, applying <code>handle_fired</code> to each such <code>a</code>.</p><p><code>fire_past_alarms</code> visits all alarms in interval <code>now_interval_num</code>, to check their <code>Alarm.at</code>.</p><p>Behavior is unspecified if <code>handle_fired</code> accesses <code>t</code> in any way other than <code>Alarm</code> functions.</p></div></div><div><div class="spec value" id="val-max_allowed_alarm_time" class="anchored"><a href="#val-max_allowed_alarm_time" class="anchor"></a><code><span class="keyword">val</span> max_allowed_alarm_time : <span><span class="type-var">_</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../Core_kernel/Time_ns/index.html#type-t">Core_kernel.Time_ns.t</a></code></div><div><p><code>max_allowed_alarm_time t</code> returns the greatest <code>at</code> that can be supplied to <code>add</code>. <code>max_allowed_alarm_time</code> is not constant; its value increases as <code>now t</code> increases.</p></div></div><div><div class="spec value" id="val-min_allowed_alarm_interval_num" class="anchored"><a href="#val-min_allowed_alarm_interval_num" class="anchor"></a><code><span class="keyword">val</span> min_allowed_alarm_interval_num : <span><span class="type-var">_</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="Interval_num/index.html#type-t">Interval_num.t</a></code></div><div><p><code>min_allowed_alarm_interval_num t = now_interval_num t</code></p></div></div><div><div class="spec value" id="val-max_allowed_alarm_interval_num" class="anchored"><a href="#val-max_allowed_alarm_interval_num" class="anchor"></a><code><span class="keyword">val</span> max_allowed_alarm_interval_num : <span><span class="type-var">_</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="Interval_num/index.html#type-t">Interval_num.t</a></code></div><div><p><code>max_allowed_alarm_interval_num t = interval_num t (max_allowed_alarm_time t)</code></p></div></div><div><div class="spec value" id="val-add" class="anchored"><a href="#val-add" class="anchor"></a><code><span class="keyword">val</span> add : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span>at:<a href="../Core_kernel/Time_ns/index.html#type-t">Core_kernel.Time_ns.t</a></span> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="Alarm/index.html#type-t">Alarm.t</a></span></code></div><div><p><code>add t ~at a</code> adds a new value <code>a</code> to <code>t</code> and returns an alarm that can later be supplied to <code>remove</code> the alarm from <code>t</code>. <code>add</code> raises if <code>interval_num t at &lt;
      now_interval_num t || at &gt; max_allowed_alarm_time t</code>.</p></div></div><div><div class="spec value" id="val-add_at_interval_num" class="anchored"><a href="#val-add_at_interval_num" class="anchor"></a><code><span class="keyword">val</span> add_at_interval_num : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span>at:<a href="Interval_num/index.html#type-t">Interval_num.t</a></span> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="Alarm/index.html#type-t">Alarm.t</a></span></code></div><div><p><code>add_at_interval_num t ~at a</code> is equivalent to <code>add t ~at:(interval_num_start t at)
      a</code>.</p></div></div><div class="spec value" id="val-mem" class="anchored"><a href="#val-mem" class="anchor"></a><code><span class="keyword">val</span> mem : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="Alarm/index.html#type-t">Alarm.t</a></span> <span>&#45;&gt;</span> bool</code></div><div><div class="spec value" id="val-remove" class="anchored"><a href="#val-remove" class="anchor"></a><code><span class="keyword">val</span> remove : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="Alarm/index.html#type-t">Alarm.t</a></span> <span>&#45;&gt;</span> unit</code></div><div><p><code>remove t alarm</code> removes <code>alarm</code> from <code>t</code>. <code>remove</code> raises if <code>not (mem t
      alarm)</code>.</p></div></div><div><div class="spec value" id="val-reschedule" class="anchored"><a href="#val-reschedule" class="anchor"></a><code><span class="keyword">val</span> reschedule : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="Alarm/index.html#type-t">Alarm.t</a></span> <span>&#45;&gt;</span> <span>at:<a href="../Core_kernel/Time_ns/index.html#type-t">Core_kernel.Time_ns.t</a></span> <span>&#45;&gt;</span> unit</code></div><div><p><code>reschedule t alarm ~at</code> mutates <code>alarm</code> so that it will fire at <code>at</code>, i.e. so that <code>Alarm.at t alarm = at</code>. <code>reschedule</code> raises if <code>not (mem t alarm)</code> or if <code>at</code> is an invalid time for <code>t</code>, in the same situations that <code>add</code> raises.</p></div></div><div><div class="spec value" id="val-reschedule_at_interval_num" class="anchored"><a href="#val-reschedule_at_interval_num" class="anchor"></a><code><span class="keyword">val</span> reschedule_at_interval_num : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="Alarm/index.html#type-t">Alarm.t</a></span> <span>&#45;&gt;</span> <span>at:<a href="Interval_num/index.html#type-t">Interval_num.t</a></span> <span>&#45;&gt;</span> unit</code></div><div><p><code>reschedule_at_interval_num t alarm ~at</code> is equivalent to:</p><pre><code>reschedule t alarm ~at:(interval_num_start t at)</code></pre></div></div><div><div class="spec value" id="val-clear" class="anchored"><a href="#val-clear" class="anchor"></a><code><span class="keyword">val</span> clear : <span><span class="type-var">_</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> unit</code></div><div><p><code>clear t</code> removes all alarms from <code>t</code>.</p></div></div><div><div class="spec value" id="val-min_alarm_interval_num" class="anchored"><a href="#val-min_alarm_interval_num" class="anchor"></a><code><span class="keyword">val</span> min_alarm_interval_num : <span><span class="type-var">_</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><a href="Interval_num/index.html#type-t">Interval_num.t</a> option</span></code></div><div><p><code>min_alarm_interval_num t</code> is the minimum <code>Alarm.interval_num</code> of all alarms in <code>t</code>.</p></div></div><div><div class="spec value" id="val-min_alarm_interval_num_exn" class="anchored"><a href="#val-min_alarm_interval_num_exn" class="anchor"></a><code><span class="keyword">val</span> min_alarm_interval_num_exn : <span><span class="type-var">_</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="Interval_num/index.html#type-t">Interval_num.t</a></code></div><div><p><code>min_alarm_interval_num_exn t</code> is like <code>min_alarm_interval_num</code>, except it raises if <code>is_empty t</code>.</p></div></div><div><div class="spec value" id="val-max_alarm_time_in_min_interval" class="anchored"><a href="#val-max_alarm_time_in_min_interval" class="anchor"></a><code><span class="keyword">val</span> max_alarm_time_in_min_interval : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><a href="../Core_kernel/Time_ns/index.html#type-t">Core_kernel.Time_ns.t</a> option</span></code></div><div><p><code>max_alarm_time_in_min_interval t</code> returns the maximum <code>Alarm.at</code> over all alarms in <code>t</code> whose <code>Alarm.interval_num</code> is <code>min_alarm_interval_num t</code>. This function is useful for advancing to the <code>min_alarm_interval_num</code> of a timing wheel and then calling <code>fire_past_alarms</code> to fire the alarms in that interval. That is useful when simulating time, to ensure that alarms are processed in order.</p></div></div><div><div class="spec value" id="val-max_alarm_time_in_min_interval_exn" class="anchored"><a href="#val-max_alarm_time_in_min_interval_exn" class="anchor"></a><code><span class="keyword">val</span> max_alarm_time_in_min_interval_exn : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../Core_kernel/Time_ns/index.html#type-t">Core_kernel.Time_ns.t</a></code></div><div><p><code>max_alarm_time_in_min_interval_exn t</code> is like <code>max_alarm_time_in_min_interval</code>, except that it raises if <code>is_empty t</code>.</p></div></div><div><div class="spec value" id="val-next_alarm_fires_at" class="anchored"><a href="#val-next_alarm_fires_at" class="anchor"></a><code><span class="keyword">val</span> next_alarm_fires_at : <span><span class="type-var">_</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><a href="../Core_kernel/Time_ns/index.html#type-t">Core_kernel.Time_ns.t</a> option</span></code></div><div><p><code>next_alarm_fires_at t</code> returns the minimum time to which the clock can be advanced such that an alarm will fire, or <code>None</code> if <code>t</code> has no alarms (or all alarms are in the max interval, and hence cannot fire). If <code>next_alarm_fires_at t = Some next</code>, then for the minimum alarm time <code>min</code> that occurs in <code>t</code>, it is guaranteed that: <code>next - alarm_precision t &lt;= min &lt; next</code>.</p></div></div><div><div class="spec value" id="val-next_alarm_fires_at_exn" class="anchored"><a href="#val-next_alarm_fires_at_exn" class="anchor"></a><code><span class="keyword">val</span> next_alarm_fires_at_exn : <span><span class="type-var">_</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../Core_kernel/Time_ns/index.html#type-t">Core_kernel.Time_ns.t</a></code></div><div><p><code>next_alarm_fires_at_exn</code> is like <code>next_alarm_fires_at</code>, except that it raises if <code>is_empty t</code>.</p></div></div><div class="spec module" id="module-Private" class="anchored"><a href="#module-Private" class="anchor"></a><code><span class="keyword">module</span> <a href="Private/index.html">Private</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div></div></div></div></div></body></html>